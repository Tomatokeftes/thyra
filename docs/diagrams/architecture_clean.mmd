%%{init: {'theme': 'base', 'themeVariables': { 'primaryColor': '#E3F2FD', 'primaryTextColor': '#1565C0', 'primaryBorderColor': '#1565C0', 'lineColor': '#424242', 'secondaryColor': '#E8F5E9', 'tertiaryColor': '#FFF3E0'}}}%%

flowchart TB
    subgraph CORE["THYRA CORE"]
        direction LR
        BMR["BaseMSIReader"]
        BMC["BaseMSIConverter"]
        ME["MetadataExtractor"]
        REG["Plugin Registry"]
    end

    subgraph READERS["INPUT READERS"]
        direction TB
        IR["ImzMLReader<br/><i>.imzml + .ibd</i>"]
        BR["BrukerReader<br/><i>.d directories</i>"]
        FR["Future Readers<br/><i>Community</i>"]:::future
    end

    subgraph RESAMPLING["RESAMPLING"]
        direction TB
        DT["Decision Tree"]
        MAG["Mass Axis Generators<br/><i>Linear | TOF | FTICR | Orbitrap</i>"]
        RS["Strategies<br/><i>Nearest Neighbor | TIC-Preserving</i>"]
    end

    subgraph CONVERTERS["OUTPUT CONVERTERS"]
        direction TB
        SD2D["SpatialData2DConverter"]
        SD3D["SpatialData3DConverter"]
        FC["Future Converters<br/><i>Community</i>"]:::future
    end

    subgraph OUTPUT["SPATIALDATA / ZARR"]
        direction LR
        TAB["Tables<br/><i>AnnData</i>"]
        SHP["Shapes<br/><i>GeoDataFrame</i>"]
        IMG["Images<br/><i>xarray</i>"]
        META["Metadata"]
    end

    %% Connections
    BMR & BMC & ME --> REG
    REG --> IR & BR
    REG -.-> FR
    IR & BR --> DT
    FR -.-> DT
    DT --> MAG --> RS
    RS --> SD2D & SD3D
    REG -.-> FC
    SD2D & SD3D --> OUTPUT
    FC -.-> OUTPUT

    %% Styling
    classDef future fill:#FAFAFA,stroke:#9E9E9E,stroke-width:2px,stroke-dasharray: 5 5
